<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css">
  <script src="//cdn.jsdelivr.net/npm/pace-js@1/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"ouzhanbo.top","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":true,"lazyload":false,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Javaweb 从 web.xml 到 springboot前言这篇文章依然是参考了这位大佬的文章，讲得已经非常细了，真的非常建议去看下大佬的文章。 几乎所有人都是从 servlet，jsp，filter 开始编写自己的第一个 hello world 工程。那时，还离不开 web.xml 的配置，在 xml 文件中编写繁琐的 servlet 和 filter 的配置。随着 spring 的普及，配">
<meta property="og:type" content="article">
<meta property="og:title" content="Javaweb从web.xml 到 springboot">
<meta property="og:url" content="https://ouzhanbo.top/2022/01/21/Javaweb%E4%BB%8Eweb.xml%20%E5%88%B0%20springboot/index.html">
<meta property="og:site_name" content="OUZHANBO">
<meta property="og:description" content="Javaweb 从 web.xml 到 springboot前言这篇文章依然是参考了这位大佬的文章，讲得已经非常细了，真的非常建议去看下大佬的文章。 几乎所有人都是从 servlet，jsp，filter 开始编写自己的第一个 hello world 工程。那时，还离不开 web.xml 的配置，在 xml 文件中编写繁琐的 servlet 和 filter 的配置。随着 spring 的普及，配">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/OUZHANBO/pics/img/6aa20d76-53bb-4934-92fb-b3ef599f3907.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/OUZHANBO/pics/img/f27438f5-f759-4995-a322-997d77f1f59c.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/OUZHANBO/pics/img/4ad2fa68-43c2-4504-ad14-71f1907d6b03.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/OUZHANBO/pics/img/ad20c5eb-720e-4c78-8e7f-46a72a187594.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/OUZHANBO/pics/img/0c06a34c-fdde-49e9-8c9b-212a48fdaf5e.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/OUZHANBO/pics/img/44b0d7d3-5227-44b9-8a84-f5ce02705d07.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/OUZHANBO/pics/img/3b086659-4b39-467f-877e-0b8db6b56bd1.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/OUZHANBO/pics/img/04237254-ea0d-499e-b3c2-16775a770d0d.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/OUZHANBO/pics/img/b0909736-c773-45e4-b5e5-59539bf170ce.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/OUZHANBO/pics/img/2f380a44-8634-4952-a81d-4e9ea7133799.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/OUZHANBO/pics/img/00c97827-4f26-4cbf-8a71-6b243b9bda75.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/OUZHANBO/pics/img/a2596a50-a161-4e7d-b916-bf04cc451d4f.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/OUZHANBO/pics/img/98e9a2e0-02a8-4a9b-983b-f7aaff87b84c.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/OUZHANBO/pics/img/a007d899-eca2-4c32-94d2-709997de5177.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/OUZHANBO/pics/img/b2318c2a-df88-4880-a8af-ffd0e6fc58b0.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/OUZHANBO/pics/img/44413ff6-b032-42f9-96c9-d2caf276d357.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/OUZHANBO/pics/img/32a7d016-e2d4-4bbe-8aaf-3210e85b4370.jpg">
<meta property="article:published_time" content="2022-01-21T01:07:12.000Z">
<meta property="article:modified_time" content="2023-10-27T08:16:44.500Z">
<meta property="article:author" content="ouzhanbo">
<meta property="article:tag" content="java">
<meta property="article:tag" content="Spring">
<meta property="article:tag" content="SpringBoot">
<meta property="article:tag" content="Servlet">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/OUZHANBO/pics/img/6aa20d76-53bb-4934-92fb-b3ef599f3907.png">

<link rel="canonical" href="https://ouzhanbo.top/2022/01/21/Javaweb%E4%BB%8Eweb.xml%20%E5%88%B0%20springboot/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Javaweb从web.xml 到 springboot | OUZHANBO</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">OUZHANBO</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">对于我这种菜鸡来说，毕业等于失业</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/OUZHANBO" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ouzhanbo.top/2022/01/21/Javaweb%E4%BB%8Eweb.xml%20%E5%88%B0%20springboot/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="ouzhanbo">
      <meta itemprop="description" content="好烦想辞职">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OUZHANBO">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Javaweb从web.xml 到 springboot
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-21 09:07:12" itemprop="dateCreated datePublished" datetime="2022-01-21T09:07:12+08:00">2022-01-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-10-27 16:16:44" itemprop="dateModified" datetime="2023-10-27T16:16:44+08:00">2023-10-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SpringBoot/" itemprop="url" rel="index"><span itemprop="name">SpringBoot</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Servlet/" itemprop="url" rel="index"><span itemprop="name">Servlet</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>55k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>50 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h3 id="Javaweb-从-web-xml-到-springboot"><a href="#Javaweb-从-web-xml-到-springboot" class="headerlink" title="Javaweb 从 web.xml 到 springboot"></a>Javaweb 从 web.xml 到 springboot</h3><h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>这篇文章依然是参考了<a target="_blank" rel="noopener" href="https://www.cnkirito.moe/servlet-explore/#Initializer-%E8%A2%AB%E6%9B%BF%E6%8D%A2%E4%B8%BA-TomcatStarter">这位大佬的文章</a>，讲得已经非常细了，真的非常建议去看下大佬的文章。</p>
<p>几乎所有人都是从 servlet，jsp，filter 开始编写自己的第一个 hello world 工程。那时，还离不开 web.xml 的配置，在 xml 文件中编写繁琐的 servlet 和 filter 的配置。随着 spring 的普及，配置逐渐演变成了两种方式—java configuration 和 xml 配置共存。现如今，springboot 的普及，java configuration 成了主流，xml 配置似乎已经“灭绝”了。不知道你有没有好奇过，这中间都发生了哪些改变，web.xml 中的配置项又是被什么替代项取代了？</p>
<h4 id="servlet3-0-以前的时代（使用-web-xml-配置）"><a href="#servlet3-0-以前的时代（使用-web-xml-配置）" class="headerlink" title="servlet3.0 以前的时代（使用 web.xml 配置）"></a>servlet3.0 以前的时代（使用 web.xml 配置）</h4><p>项目的结构和部分代码</p>
<p><img src="https://cdn.jsdelivr.net/gh/OUZHANBO/pics/img/6aa20d76-53bb-4934-92fb-b3ef599f3907.png" alt="图片丢失" title="项目的结构"></p>
<span id="more"></span>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        resp.setContentType(<span class="string">&quot;text/plain&quot;</span>);</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> resp.getWriter();</span><br><span class="line">        out.println(<span class="string">&quot;hello world&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;触发 hello world 过滤器...&quot;</span>);</span><br><span class="line">        filterChain.doFilter(servletRequest,servletResponse);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 servlet3.0 之前需要将需要上面的 HelloWorldServlet 和 HelloWorldFilter 配置在<code>WEB-INF/web.xml</code>文件里面才会生效</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> &gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>Archetype Created Web Application<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>HelloWorldServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>top.ouzhanbo.webxml.servlet.HelloWorldServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>HelloWorldServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/hello<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>HelloWorldFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>top.ouzhanbo.webxml.filter.HelloWorldFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>HelloWorldFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/hello<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="servlet3-0-新特性"><a href="#servlet3-0-新特性" class="headerlink" title="servlet3.0 新特性"></a>servlet3.0 新特性</h4><p>Servlet 3.0 作为 Java EE 6 规范体系中一员，随着 Java EE 6 规范一起发布。该版本在前一版本（Servlet 2.5）的基础上提供了若干新特性用于简化 Web 应用的开发和部署。其中一项新特性便是提供了无 xml 配置的特性。</p>
<p>servlet3.0 首先提供了 @WebServlet，@WebFilter 等注解，这样便有了抛弃 web.xml 的第一个途径，凭借注解声明 servlet 和 filter 来做到这一点。</p>
<p>除了这种方式，servlet3.0 规范还提供了更强大的功能，可以在运行时动态注册 servlet ，filter，listener。以 servlet 为例，过滤器与监听器与之类似。ServletContext 为动态配置 Servlet 增加了如下方法：</p>
<ul>
<li>ServletRegistration.Dynamic addServlet(String servletName,Class&lt;? extends Servlet&gt; servletClass)</li>
<li>ServletRegistration.Dynamic addServlet(String servletName, Servlet servlet)</li>
<li>ServletRegistration.Dynamic addServlet(String servletName, String className)</li>
<li>T createServlet(Class clazz)</li>
<li>ServletRegistration getServletRegistration(String servletName)</li>
<li>Map<String,? extends ServletRegistration> getServletRegistrations()</li>
</ul>
<p>其中前三个方法的作用是相同的，只是参数类型不同而已；通过 createServlet()方法创建的 Servlet，通常需要做一些自定义的配置，然后使用 addServlet() 方法来将其动态注册为一个可以用于服务的 Servlet。两个 getServletRegistration() 方法主要用于动态为 Servlet 增加映射信息，这等价于在 web.xml 中使用 标签为存在的 Servlet 增加映射信息。上面的 ServletRegistration.Dynamic 看源码发现其实他是继承了 ServletRegistration（FilterRegistration 也是类似）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ServletRegistration</span> <span class="keyword">extends</span> <span class="title class_">Registration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">interface</span> <span class="title class_">Dynamic</span> <span class="keyword">extends</span> <span class="title class_">ServletRegistration</span>, Registration.Dynamic &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLoadOnStartup</span><span class="params">(<span class="type">int</span> loadOnStartup)</span>;</span><br><span class="line">        <span class="keyword">public</span> Set&lt;String&gt; <span class="title function_">setServletSecurity</span><span class="params">(ServletSecurityElement constraint)</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMultipartConfig</span><span class="params">(MultipartConfigElement multipartConfig)</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRunAsRole</span><span class="params">(String roleName)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上 ServletContext 新增的方法要么是在 ServletContextListener 的 contexInitialized 方法中调用，要么是在 ServletContainerInitializer 的 onStartup() 方法中调用。</p>
<p>ServletContainerInitializer 也是 Servlet 3.0 新增的一个接口，容器在启动时使用 JAR 服务 API(JAR Service API) 来发现 ServletContainerInitializer 的实现类，并且容器将 WEB-INF/lib 目录下 JAR 包中的类都交给该类的 onStartup()方法处理，我们通常需要在该实现类上使用 @HandlesTypes 注解来指定希望被处理的类，过滤掉不希望给 onStartup() 处理的类。</p>
<p>servlet3.0+的项目结构和部分代码</p>
<p><img src="https://cdn.jsdelivr.net/gh/OUZHANBO/pics/img/f27438f5-f759-4995-a322-997d77f1f59c.jpg" alt="图片丢失" title="项目结构"></p>
<p>我并未对 HelloWorldServlet 和 HelloWorldFilter 做任何改动，而是新增了一个 CustomServletContainerInitializer , 它实现了 <code>javax.servlet.ServletContainerInitializer</code> 接口，用来在 web 容器启动时加载指定的 servlet 和 filter，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomServletContainerInitializer</span> <span class="keyword">implements</span> <span class="title class_">ServletContainerInitializer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">JAR_HELLO_URL</span> <span class="operator">=</span> <span class="string">&quot;/hello&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStartup</span><span class="params">(Set&lt;Class&lt;?&gt;&gt; c, ServletContext servletContext)</span> <span class="keyword">throws</span> ServletException&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;创建 helloWorldServlet...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ServletRegistration.<span class="type">Dynamic</span> <span class="variable">servlet</span> <span class="operator">=</span> servletContext.addServlet(</span><br><span class="line">                HelloWorldServlet.class.getSimpleName(),</span><br><span class="line">                HelloWorldServlet.class);</span><br><span class="line">        servlet.addMapping(JAR_HELLO_URL);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;创建 helloWorldFilter...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        FilterRegistration.<span class="type">Dynamic</span> <span class="variable">filter</span> <span class="operator">=</span> servletContext.addFilter(</span><br><span class="line">                HelloWorldFilter.class.getSimpleName(), HelloWorldFilter.class);</span><br><span class="line"></span><br><span class="line">        EnumSet&lt;DispatcherType&gt; dispatcherTypes = EnumSet.allOf(DispatcherType.class);</span><br><span class="line">        dispatcherTypes.add(DispatcherType.REQUEST);</span><br><span class="line">        dispatcherTypes.add(DispatcherType.FORWARD);</span><br><span class="line"></span><br><span class="line">        filter.addMappingForUrlPatterns(dispatcherTypes, <span class="literal">true</span>, JAR_HELLO_URL);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ServletContext 我们称之为 servlet 上下文，它维护了整个 web 容器中注册的 servlet，filter，listener，以 servlet 为例，可以使用 servletContext.addServlet 等方法来添加 servlet。在上面没用到方法入参中<code>Set&lt;Class&lt;?&gt;&gt; c</code>和注解<code>@HandlesTypes</code>，这里说下这两个东西的作用，<code>@HandlesTypes</code>注解上可以指定需要处理的类，onStartup 方法被调用时将<code>@HandlesTypes</code>中指定类的子类（一定记住是子类，该类的本身不算）放入<code>Set&lt;Class&lt;?&gt;&gt; c</code>这个集合中，如果没有使用<code>@HandlesTypes</code>注解指定处理的类，那<code>Set&lt;Class&lt;?&gt;&gt; c</code>就为<code>null</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/OUZHANBO/pics/img/4ad2fa68-43c2-4504-ad14-71f1907d6b03.jpg" alt="图片丢失" title="@HandlesTypes注解Set&lt; Class &lt; ? &gt; &gt; c为null"></p>
<p><img src="https://cdn.jsdelivr.net/gh/OUZHANBO/pics/img/ad20c5eb-720e-4c78-8e7f-46a72a187594.jpg" alt="图片丢失" title="HelloWorldServlet这个类本身不会被放入Set&lt; Class &lt; ? &gt; &gt; c"></p>
<p><img src="https://cdn.jsdelivr.net/gh/OUZHANBO/pics/img/0c06a34c-fdde-49e9-8c9b-212a48fdaf5e.jpg" alt="图片丢失" title="HttpServlet子类HelloWorldServlet才会被放入Set&lt; Class &lt; ? &gt; &gt; c"></p>
<p>这么声明一个 ServletContainerInitializer 的实现类，web 容器并不会识别它，所以，需要借助 SPI 机制(如果不懂 SPI 的可以看看<a href="https://ouzhanbo.top/2021/12/16/SPI%E6%9C%BA%E5%88%B6/">这篇文章</a>)来指定该初始化类，这一步骤是通过在项目路径下创建 <code>META-INF/services/javax.servlet.ServletContainerInitializer</code> 来做到的，它只包含一行内容：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">top.ouzhanbo.websci.CustomServletContainerInitializer</span><br></pre></td></tr></table></figure>
<p>使用 ServletContainerInitializer 和 SPI 机制，我们的 web 应用便可以彻底摆脱 web.xml 了。</p>
<p>在 ContextConfig 类中可以看到通过 SPI 加载 ServletContainerInitializer 的实现类的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">List&lt;ServletContainerInitializer&gt; detectedScis;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    WebappServiceLoader&lt;ServletContainerInitializer&gt; loader = <span class="keyword">new</span> <span class="title class_">WebappServiceLoader</span>&lt;&gt;(context);</span><br><span class="line">    <span class="comment">//SPI加载ServletContainerInitializer的实现类</span></span><br><span class="line">    detectedScis = loader.load(ServletContainerInitializer.class);</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    log.error(sm.getString(</span><br><span class="line">            <span class="string">&quot;contextConfig.servletContainerInitializerFail&quot;</span>,</span><br><span class="line">            context.getName()),</span><br><span class="line">        e);</span><br><span class="line">    ok = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 StandardContext 类中可以看到 ServletContainerInitializer 的 onStartup 方法被调用的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Call ServletContainerInitializers</span></span><br><span class="line"><span class="keyword">for</span> (Map.Entry&lt;ServletContainerInitializer, Set&lt;Class&lt;?&gt;&gt;&gt; entry :</span><br><span class="line">    initializers.entrySet()) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        entry.getKey().onStartup(entry.getValue(),</span><br><span class="line">                getServletContext());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ServletException e) &#123;</span><br><span class="line">        log.error(sm.getString(<span class="string">&quot;standardContext.sciFail&quot;</span>), e);</span><br><span class="line">        ok = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Spring-是如何支持-servlet3-0-的？"><a href="#Spring-是如何支持-servlet3-0-的？" class="headerlink" title="Spring 是如何支持 servlet3.0 的？"></a>Spring 是如何支持 servlet3.0 的？</h4><p>在我最初接触 spring 的时候虽然已经有 servlet3.0 但是那时候都是在网上找一些视频来学习的，基本都是学到能用就觉得可以了，当时学的 springmvc+spring+mybatis 里面的 spirngmvc 和 spring 的配置都是用 xml 的，但是当时其实不是很懂 web.xml 中配的那个 listener 和 servlet 标签里面的那个初始化参数标签 init-param 里面那个东西有什么用，后来 springboot 出来后基本就用 springboot 了基本没在用过 ssm 那一套了，所以 spring 搭配 servlet3.0 那套无 xml 配置的方式我完全没用过，看了<a target="_blank" rel="noopener" href="https://www.cnkirito.moe/servlet-explore/#Initializer-%E8%A2%AB%E6%9B%BF%E6%8D%A2%E4%B8%BA-TomcatStarter">这位大佬的文章</a>加上百度再搜索了一波资料加上自己调试，现在大概弄懂了用 xml 和用 javaConfig 这两种方式浅显的原理。</p>
<h5 id="使用-xml-配置的方式"><a href="#使用-xml-配置的方式" class="headerlink" title="使用 xml 配置的方式"></a>使用 xml 配置的方式</h5><p>先看看项目的结构和部分的代码</p>
<p><img src="https://cdn.jsdelivr.net/gh/OUZHANBO/pics/img/44b0d7d3-5227-44b9-8a84-f5ce02705d07.jpg" alt="图片丢失" title="通过xml配置的情况下使用Spring"></p>
<p>代码和配置如下</p>
<p>web.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns</span>=<span class="string">&quot;http://java.sun.com/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">id</span>=<span class="string">&quot;WebApp_ID&quot;</span> <span class="attr">version</span>=<span class="string">&quot;3.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>Archetype Created Web Application<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- servlet容器初始化时的参数，可以通过servletContext.getInitParameter(&quot;contextConfigLocation&quot;)获取   --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath*:/application.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置servlet容器的监听器 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>dispatcherServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- servlet的初始化时的参数，可以在DispatcherServlet里通过getInitParameter(&quot;contextConfigLocation&quot;)获取 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath*:/application-mvc.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- servlet的加载顺序，如果是为负数就是在第一次请求该servlet时候才会加载，当值为0或者大于0时，表示容器在应用启动时就加载并初始化这个servlet，正数的值越小，该servlet的优先级越高，应用启动时就越先加载   --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>dispatcherServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Spring 的配置 application.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">                        http://www.springframework.org/schema/beans/spring-beans-3.1.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">                        http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">                        http://www.springframework.org/schema/context/spring-context-3.1.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- spring容器扫描 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;top.ouzhanbo.webspring&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 不扫描spring mvc的controller --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">context:exclude-filter</span> <span class="attr">type</span>=<span class="string">&quot;annotation&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;org.springframework.stereotype.Controller&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>SpringMvc 的配置 application-mvc.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">                            http://www.springframework.org/schema/beans/spring-beans-3.1.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">                            http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">                            http://www.springframework.org/schema/context/spring-context-3.1.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--spring mvc扫描controller不扫描service--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;top.ouzhanbo.webspring&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">context:include-filter</span> <span class="attr">type</span>=<span class="string">&quot;annotation&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;org.springframework.stereotype.Controller&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">context:exclude-filter</span> <span class="attr">type</span>=<span class="string">&quot;annotation&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;org.springframework.stereotype.Service&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>MyController 的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyController</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value=&quot;/hello&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们在 web.xml 上面配置的监听器 ContextLoaderListener 继承 ContextLoader 类并实现了 ServletContextListener 接口，实现了 ServletContextListener 接口的监听器会监听 servelet 容器，在 servelet 容器启动和关闭时会触发该监听器</p>
<p>ServletContextListener</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ServletContextListener</span> <span class="keyword">extends</span> <span class="title class_">EventListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//servlet容器启动时调用</span></span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">contextInitialized</span><span class="params">(ServletContextEvent sce)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//servlet容器销毁时调用</span></span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">contextDestroyed</span><span class="params">(ServletContextEvent sce)</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ContextLoaderListener</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">ContextLoaderListener <span class="keyword">extends</span> <span class="title class_">ContextLoader</span> <span class="keyword">implements</span> <span class="title class_">ServletContextListener</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">ContextLoaderListener</span><span class="params">()</span> &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">ContextLoaderListener</span><span class="params">(WebApplicationContext context)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(context);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">contextInitialized</span><span class="params">(ServletContextEvent event)</span> &#123;</span><br><span class="line">    <span class="comment">//创建并且初始化Spring容器</span></span><br><span class="line">    initWebApplicationContext(event.getServletContext());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">contextDestroyed</span><span class="params">(ServletContextEvent event)</span> &#123;</span><br><span class="line">    closeWebApplicationContext(event.getServletContext());</span><br><span class="line">    ContextCleanupListener.cleanupAttributes(event.getServletContext());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看 Tomcat 源码，在 StandardContext 里面的 listenerStart 方法里面有段代码就是获取 ServletContextListener 接口的实现类并且调用它的 contextInitialized 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">Object instances[] = getApplicationLifecycleListeners();</span><br><span class="line">       <span class="keyword">if</span> (instances == <span class="literal">null</span> || instances.length == <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> ok;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="type">ServletContextEvent</span> <span class="variable">event</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletContextEvent</span>(getServletContext());</span><br><span class="line">       <span class="type">ServletContextEvent</span> <span class="variable">tldEvent</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">       <span class="keyword">if</span> (noPluggabilityListeners.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">           noPluggabilityServletContext = <span class="keyword">new</span> <span class="title class_">NoPluggabilityServletContext</span>(getServletContext());</span><br><span class="line">           tldEvent = <span class="keyword">new</span> <span class="title class_">ServletContextEvent</span>(noPluggabilityServletContext);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">for</span> (Object instance : instances) &#123;</span><br><span class="line">           <span class="keyword">if</span> (!(instance <span class="keyword">instanceof</span> ServletContextListener)) &#123;</span><br><span class="line">               <span class="keyword">continue</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">//获取实现了ServletContextListener的监听器</span></span><br><span class="line">           <span class="type">ServletContextListener</span> <span class="variable">listener</span> <span class="operator">=</span> (ServletContextListener) instance;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               fireContainerEvent(<span class="string">&quot;beforeContextInitialized&quot;</span>, listener);</span><br><span class="line">               <span class="keyword">if</span> (noPluggabilityListeners.contains(listener)) &#123;</span><br><span class="line">                   listener.contextInitialized(tldEvent);</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="comment">//调用contextInitialized方法</span></span><br><span class="line">                   listener.contextInitialized(event);</span><br><span class="line">               &#125;</span><br><span class="line">               fireContainerEvent(<span class="string">&quot;afterContextInitialized&quot;</span>, listener);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">               ExceptionUtils.handleThrowable(t);</span><br><span class="line">               fireContainerEvent(<span class="string">&quot;afterContextInitialized&quot;</span>, listener);</span><br><span class="line">               getLogger().error(sm.getString(<span class="string">&quot;standardContext.listenerStart&quot;</span>,</span><br><span class="line">                       instance.getClass().getName()), t);</span><br><span class="line">               ok = <span class="literal">false</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p>之后就是调用 ContextLoader 的 initWebApplicationContext 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> WebApplicationContext <span class="title function_">initWebApplicationContext</span><span class="params">(ServletContext servletContext)</span> &#123;</span><br><span class="line">  <span class="comment">//先判断是不是已经创建过了spring的根容器（大部分被spring管理的类都放在这里面，比如被@Service @@Repository，@Component注解标注的类）</span></span><br><span class="line">  <span class="keyword">if</span> (servletContext.getAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE) != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(</span><br><span class="line">        <span class="string">&quot;Cannot initialize context because there is already a root application context present - &quot;</span> +</span><br><span class="line">        <span class="string">&quot;check whether you have multiple ContextLoader* definitions in your web.xml!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  servletContext.log(<span class="string">&quot;Initializing Spring root WebApplicationContext&quot;</span>);</span><br><span class="line">  <span class="type">Log</span> <span class="variable">logger</span> <span class="operator">=</span> LogFactory.getLog(ContextLoader.class);</span><br><span class="line">  <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">    logger.info(<span class="string">&quot;Root WebApplicationContext: initialization started&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// Store context in local instance variable, to guarantee that</span></span><br><span class="line">    <span class="comment">// it is available on ServletContext shutdown.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.context == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">//如果没有在context-param里面指定ContextLoader里面的contextClass的值的话，默认使用的时org.springframework.web.context.support.XmlWebApplicationContext这个类的创建的容器（感兴趣的话可以点进去看下就知道了）</span></span><br><span class="line">      <span class="built_in">this</span>.context = createWebApplicationContext(servletContext);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.context <span class="keyword">instanceof</span> ConfigurableWebApplicationContext) &#123;</span><br><span class="line">      <span class="type">ConfigurableWebApplicationContext</span> <span class="variable">cwac</span> <span class="operator">=</span> (ConfigurableWebApplicationContext) <span class="built_in">this</span>.context;</span><br><span class="line">      <span class="keyword">if</span> (!cwac.isActive()) &#123;</span><br><span class="line">        <span class="comment">// The context has not yet been refreshed -&gt; provide services such as</span></span><br><span class="line">        <span class="comment">// setting the parent context, setting the application context id, etc</span></span><br><span class="line">        <span class="keyword">if</span> (cwac.getParent() == <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">// The context instance was injected without an explicit parent -&gt;</span></span><br><span class="line">          <span class="comment">// determine parent for root web application context, if any.</span></span><br><span class="line">          <span class="type">ApplicationContext</span> <span class="variable">parent</span> <span class="operator">=</span> loadParentContext(servletContext);</span><br><span class="line">          cwac.setParent(parent);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//最终会到这里，看方法名配置并刷新web应用容器</span></span><br><span class="line">        configureAndRefreshWebApplicationContext(cwac, servletContext);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//将spring容器保存到servlet容器中</span></span><br><span class="line">    servletContext.setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE, <span class="built_in">this</span>.context);</span><br><span class="line"></span><br><span class="line">    <span class="type">ClassLoader</span> <span class="variable">ccl</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader();</span><br><span class="line">    <span class="keyword">if</span> (ccl == ContextLoader.class.getClassLoader()) &#123;</span><br><span class="line">      currentContext = <span class="built_in">this</span>.context;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (ccl != <span class="literal">null</span>) &#123;</span><br><span class="line">      currentContextPerThread.put(ccl, <span class="built_in">this</span>.context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">      <span class="type">long</span> <span class="variable">elapsedTime</span> <span class="operator">=</span> System.currentTimeMillis() - startTime;</span><br><span class="line">      logger.info(<span class="string">&quot;Root WebApplicationContext initialized in &quot;</span> + elapsedTime + <span class="string">&quot; ms&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.context;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (RuntimeException | Error ex) &#123;</span><br><span class="line">    logger.error(<span class="string">&quot;Context initialization failed&quot;</span>, ex);</span><br><span class="line">    servletContext.setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE, ex);</span><br><span class="line">    <span class="keyword">throw</span> ex;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>configureAndRefreshWebApplicationContext</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ContextLoader</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONFIG_LOCATION_PARAM</span> <span class="operator">=</span> <span class="string">&quot;contextConfigLocation&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configureAndRefreshWebApplicationContext</span><span class="params">(ConfigurableWebApplicationContext wac, ServletContext sc)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (ObjectUtils.identityToString(wac).equals(wac.getId())) &#123;</span><br><span class="line">      <span class="comment">// The application context id is still set to its original default value</span></span><br><span class="line">      <span class="comment">// -&gt; assign a more useful id based on available information</span></span><br><span class="line">      <span class="type">String</span> <span class="variable">idParam</span> <span class="operator">=</span> sc.getInitParameter(CONTEXT_ID_PARAM);</span><br><span class="line">      <span class="keyword">if</span> (idParam != <span class="literal">null</span>) &#123;</span><br><span class="line">        wac.setId(idParam);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Generate default id...</span></span><br><span class="line">        wac.setId(ConfigurableWebApplicationContext.APPLICATION_CONTEXT_ID_PREFIX +</span><br><span class="line">            ObjectUtils.getDisplayString(sc.getContextPath()));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    wac.setServletContext(sc);</span><br><span class="line">    <span class="comment">//这里的CONFIG_LOCATION_PARAM就是contextConfigLocation，这里就是获取到在web.xml中context-param配置contextConfigLocation的值classpath*:/application.xml</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">configLocationParam</span> <span class="operator">=</span> sc.getInitParameter(CONFIG_LOCATION_PARAM);</span><br><span class="line">    <span class="keyword">if</span> (configLocationParam != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">//将spring容器的配置文件application.xml的放入到容器中，后面调用wac.refresh()会用到</span></span><br><span class="line">      wac.setConfigLocation(configLocationParam);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The wac environment&#x27;s #initPropertySources will be called in any case when the context</span></span><br><span class="line">    <span class="comment">// is refreshed; do it eagerly here to ensure servlet property sources are in place for</span></span><br><span class="line">    <span class="comment">// use in any post-processing or initialization that occurs below prior to #refresh</span></span><br><span class="line">    <span class="type">ConfigurableEnvironment</span> <span class="variable">env</span> <span class="operator">=</span> wac.getEnvironment();</span><br><span class="line">    <span class="keyword">if</span> (env <span class="keyword">instanceof</span> ConfigurableWebEnvironment) &#123;</span><br><span class="line">      ((ConfigurableWebEnvironment) env).initPropertySources(sc, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    customizeContext(sc, wac);</span><br><span class="line">    wac.refresh();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>在 refresh 方法里面的层层深入后 XmlWebApplicationContext 这个类的 loadBeanDefinitions 方法里面看到之前保存的 spring 容器的配置文件路径</p>
<p><img src="https://cdn.jsdelivr.net/gh/OUZHANBO/pics/img/3b086659-4b39-467f-877e-0b8db6b56bd1.png" alt="图片丢失" title="loadBeanDefinitions加载application.xml"></p>
<p>之后就是 spring 的加载配置文件的源码了，这里就不展开了（我也没怎么看过），讲那么多其实最关键的就是知道 Spring 容器是通过在 Servlet 容器初始化的时候调用监听器 ContextLoaderListener 的 contextInitialized 方法加载到 Servlet 容器中的。</p>
<p>那么 springmvc 的容器是在哪里加载进来的呢？其实不难猜到就在 DispatcherServlet 初始化的时候加载进来的，在 StandardWrapper 里的 loadServlet 方法里通过反射的方式创建了 servlet 实例并且将其返回给了上层的 load 方法，并且在上层的 load 方法中通过调用 initServlet 方法最终调用到 servlet 的 init 方法。</p>
<p><img src="https://cdn.jsdelivr.net/gh/OUZHANBO/pics/img/04237254-ea0d-499e-b3c2-16775a770d0d.jpg" alt="图片丢失" title="StandardWrapper的loadServlet里创建servelet对象"></p>
<p><img src="https://cdn.jsdelivr.net/gh/OUZHANBO/pics/img/b0909736-c773-45e4-b5e5-59539bf170ce.jpg" alt="图片丢失" title="StandardWrapper的load方法调用了initServlet方法"></p>
<p><img src="https://cdn.jsdelivr.net/gh/OUZHANBO/pics/img/2f380a44-8634-4952-a81d-4e9ea7133799.jpg" alt="图片丢失" title="StandardWrapper的initServlet调用servlet的初始化init方法"></p>
<p>如果 servlet 是 FrameworkServlet 类或者其子类（DispatcherServlet 继承 FrameworkServlet）的实例那么层层深入后最终会调用到 FrameworkServlet 的 initWebApplicationContext 方法</p>
<p>initWebApplicationContext 方法的的代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> WebApplicationContext <span class="title function_">initWebApplicationContext</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">//这里代码如果深入的话会发现这里的rootContext就是我们上面保存到servlet容器里面的spring容器</span></span><br><span class="line">  <span class="type">WebApplicationContext</span> <span class="variable">rootContext</span> <span class="operator">=</span></span><br><span class="line">      WebApplicationContextUtils.getWebApplicationContext(getServletContext());</span><br><span class="line">  <span class="type">WebApplicationContext</span> <span class="variable">wac</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.webApplicationContext != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// A context instance was injected at construction time -&gt; use it</span></span><br><span class="line">    wac = <span class="built_in">this</span>.webApplicationContext;</span><br><span class="line">    <span class="keyword">if</span> (wac <span class="keyword">instanceof</span> ConfigurableWebApplicationContext) &#123;</span><br><span class="line">      <span class="type">ConfigurableWebApplicationContext</span> <span class="variable">cwac</span> <span class="operator">=</span> (ConfigurableWebApplicationContext) wac;</span><br><span class="line">      <span class="keyword">if</span> (!cwac.isActive()) &#123;</span><br><span class="line">        <span class="comment">// The context has not yet been refreshed -&gt; provide services such as</span></span><br><span class="line">        <span class="comment">// setting the parent context, setting the application context id, etc</span></span><br><span class="line">        <span class="keyword">if</span> (cwac.getParent() == <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">// The context instance was injected without an explicit parent -&gt; set</span></span><br><span class="line">          <span class="comment">// the root application context (if any; may be null) as the parent</span></span><br><span class="line">          cwac.setParent(rootContext);</span><br><span class="line">        &#125;</span><br><span class="line">        configureAndRefreshWebApplicationContext(cwac);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (wac == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// No context instance was injected at construction time -&gt; see if one</span></span><br><span class="line">    <span class="comment">// has been registered in the servlet context. If one exists, it is assumed</span></span><br><span class="line">    <span class="comment">// that the parent context (if any) has already been set and that the</span></span><br><span class="line">    <span class="comment">// user has performed any initialization such as setting the context id</span></span><br><span class="line">    wac = findWebApplicationContext();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (wac == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">//会调用到这里</span></span><br><span class="line">    <span class="comment">// No context instance is defined for this servlet -&gt; create a local one</span></span><br><span class="line">    wac = createWebApplicationContext(rootContext);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">this</span>.refreshEventReceived) &#123;</span><br><span class="line">    <span class="comment">// Either the context is not a ConfigurableApplicationContext with refresh</span></span><br><span class="line">    <span class="comment">// support or the context injected at construction time had already been</span></span><br><span class="line">    <span class="comment">// refreshed -&gt; trigger initial onRefresh manually here.</span></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>.onRefreshMonitor) &#123;</span><br><span class="line">      onRefresh(wac);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.publishContext) &#123;</span><br><span class="line">    <span class="comment">// Publish the context as a servlet context attribute.</span></span><br><span class="line">    <span class="comment">//attraName的值由FrameworkServlet.class.getName() + &quot;.CONTEXT.&quot; + getServletName()组合成</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">attrName</span> <span class="operator">=</span> getServletContextAttributeName();</span><br><span class="line">    <span class="comment">//将springmvc容器以attraName的名字保存在servlet容器里</span></span><br><span class="line">    getServletContext().setAttribute(attrName, wac);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> wac;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>initWebApplicationContext 会调用到 createWebApplicationContext，最会调用到 createWebApplicationContext(@Nullable ApplicationContext parent) 方法</p>
<p>createWebApplicationContext(@Nullable ApplicationContext parent) 方法的代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> WebApplicationContext <span class="title function_">createWebApplicationContext</span><span class="params">(<span class="meta">@Nullable</span> ApplicationContext parent)</span> &#123;</span><br><span class="line">  <span class="comment">//可以在web.xml里面servlet标签里面的init-param标签里设置contextClass的值，默认值是XmlWebApplicationContext.class</span></span><br><span class="line">  Class&lt;?&gt; contextClass = getContextClass();</span><br><span class="line">  <span class="keyword">if</span> (!ConfigurableWebApplicationContext.class.isAssignableFrom(contextClass)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ApplicationContextException</span>(</span><br><span class="line">        <span class="string">&quot;Fatal initialization error in servlet with name &#x27;&quot;</span> + getServletName() +</span><br><span class="line">        <span class="string">&quot;&#x27;: custom WebApplicationContext class [&quot;</span> + contextClass.getName() +</span><br><span class="line">        <span class="string">&quot;] is not of type ConfigurableWebApplicationContext&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">ConfigurableWebApplicationContext</span> <span class="variable">wac</span> <span class="operator">=</span></span><br><span class="line">      (ConfigurableWebApplicationContext) BeanUtils.instantiateClass(contextClass);</span><br><span class="line"></span><br><span class="line">  wac.setEnvironment(getEnvironment());</span><br><span class="line">  wac.setParent(parent);</span><br><span class="line">  <span class="comment">//可以在web.xml里面servlet标签里面的init-param标签里设置contextConfigLocation的值，这里获取到值是classpath*:/application-mvc.xml</span></span><br><span class="line">  <span class="type">String</span> <span class="variable">configLocation</span> <span class="operator">=</span> getContextConfigLocation();</span><br><span class="line">  <span class="keyword">if</span> (configLocation != <span class="literal">null</span>) &#123;</span><br><span class="line">    wac.setConfigLocation(configLocation);</span><br><span class="line">  &#125;</span><br><span class="line">  configureAndRefreshWebApplicationContext(wac);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> wac;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面 contextClass 和 contextConfigLocation 的值都是在 HttpServletBean（FrameworkServlet 的父类）的 init 方法中被赋予</p>
<p><img src="https://cdn.jsdelivr.net/gh/OUZHANBO/pics/img/00c97827-4f26-4cbf-8a71-6b243b9bda75.jpg" alt="图片丢失" title="将web.xml里servlet标签里的init-param标签设置的servlet初始化的值设置到servlet对应名字的属性里"></p>
<p>最终将 springmvc 的容器保存在 servlet 容器中，这样 springmvc 就成功的加载进来了</p>
<h5 id="完全无-xml-的配置方式"><a href="#完全无-xml-的配置方式" class="headerlink" title="完全无 xml 的配置方式"></a>完全无 xml 的配置方式</h5><p>项目的结构和部分的代码</p>
<p><img src="https://cdn.jsdelivr.net/gh/OUZHANBO/pics/img/a2596a50-a161-4e7d-b916-bf04cc451d4f.jpg" alt="图片丢失" title="完全无xml的配置方式下的项目结构"></p>
<p>MyConfig 配置类的效果和上面用 xml 的方式时的 application.xml 类似，主要的针对 Spring 容器的，上面的@ComponentScan 注解的内容是告诉 Spring 容器扫描并且加载 top.ouzhanbo.webspring 下的所有被@Service 注解标注的类，useDefaultFilters = false 是为了防止 spring 默认会自动发现被 @Component、@Repository、@Service 和 @Controller 标注的类，并注册进容器中这行为。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//告诉Spring容器扫描并且加载top.ouzhanbo.webspring下的所有被@Service注解标注的类</span></span><br><span class="line"><span class="meta">@ComponentScan(value = &quot;top.ouzhanbo.webspring&quot;,includeFilters = &#123;@ComponentScan.Filter(type = FilterType.ANNOTATION, classes = &#123;Service.class&#125;)&#125;,useDefaultFilters = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MyMvcConfig 配置类和上面的 MyConfig 配置类差不多，只是这个是针对 SpringMvc 容器的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//告诉SpringMvc容器扫描并且加载top.ouzhanbo.webspring下的所有被@Controller注解标注的类</span></span><br><span class="line"><span class="meta">@ComponentScan(value = &quot;top.ouzhanbo.webspring&quot;,includeFilters = &#123;@ComponentScan.Filter(type = FilterType.ANNOTATION, classes = &#123;Controller.class&#125;)&#125;,useDefaultFilters = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyMvcConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MyController 的代码很简单，就是返回一个 hello 字符串</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyController</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value=&quot;/hello&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>WebInitializer 这个类这里先不介绍后面再说</p>
<p>前面介绍的 servlet3.0 下是如何通过 SPI 的方式注册 Servlet、Filter、Listener 的，其实在无 xml 配置的情况下 Spring 也是通过这种方式来注册 Servlet、Filter、Listener，找到 ServletContainerInitializer 的实现类 SpringServletContainerInitializer</p>
<p><img src="https://cdn.jsdelivr.net/gh/OUZHANBO/pics/img/98e9a2e0-02a8-4a9b-983b-f7aaff87b84c.jpg" alt="图片丢失" title="META-INF/S/services/javax.servlet.ServletContainerInitializer"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HandlesTypes(WebApplicationInitializer.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringServletContainerInitializer</span> <span class="keyword">implements</span> <span class="title class_">ServletContainerInitializer</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStartup</span><span class="params">(<span class="meta">@Nullable</span> Set&lt;Class&lt;?&gt;&gt; webAppInitializerClasses, ServletContext servletContext)</span></span><br><span class="line">      <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line"></span><br><span class="line">    List&lt;WebApplicationInitializer&gt; initializers = Collections.emptyList();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (webAppInitializerClasses != <span class="literal">null</span>) &#123;</span><br><span class="line">      initializers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(webAppInitializerClasses.size());</span><br><span class="line">      <span class="keyword">for</span> (Class&lt;?&gt; waiClass : webAppInitializerClasses) &#123;</span><br><span class="line">        <span class="comment">// Be defensive: Some servlet containers provide us with invalid classes,</span></span><br><span class="line">        <span class="comment">// no matter what @HandlesTypes says...</span></span><br><span class="line">        <span class="keyword">if</span> (!waiClass.isInterface() &amp;&amp; !Modifier.isAbstract(waiClass.getModifiers()) &amp;&amp;</span><br><span class="line">            WebApplicationInitializer.class.isAssignableFrom(waiClass)) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">//获取到所有WebApplicationInitializer类的子类（除了接口和抽象类）并且通过反射创建该类的实例</span></span><br><span class="line">            initializers.add((WebApplicationInitializer)</span><br><span class="line">                ReflectionUtils.accessibleConstructor(waiClass).newInstance());</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(<span class="string">&quot;Failed to instantiate WebApplicationInitializer class&quot;</span>, ex);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (initializers.isEmpty()) &#123;</span><br><span class="line">      servletContext.log(<span class="string">&quot;No Spring WebApplicationInitializer types detected on classpath&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    servletContext.log(initializers.size() + <span class="string">&quot; Spring WebApplicationInitializers detected on classpath&quot;</span>);</span><br><span class="line">    AnnotationAwareOrderComparator.sort(initializers);</span><br><span class="line">    <span class="keyword">for</span> (WebApplicationInitializer initializer : initializers) &#123;</span><br><span class="line">            <span class="comment">//调用WebApplicationInitializer的onStartup方法</span></span><br><span class="line">      initializer.onStartup(servletContext);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SpringServletContainerInitializer 的 onStartup 方法的作用就是找到所有 WebApplicationInitializer 类的子类（除了接口和抽象类）并且调用它们的 onStartup 方法（套娃吖），而我们上面的 WebInitializer 就是 WebApplicationInitializer 的子类</p>
<p>WebInitializer 的继承关系</p>
<p><img src="https://cdn.jsdelivr.net/gh/OUZHANBO/pics/img/a007d899-eca2-4c32-94d2-709997de5177.png" alt="图片丢失" title="WebInitializer的继承关系"></p>
<p>WebInitializer 的代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebInitializer</span> <span class="keyword">extends</span> <span class="title class_">AbstractAnnotationConfigDispatcherServletInitializer</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt;[] getRootConfigClasses() &#123;</span><br><span class="line">        <span class="comment">//返回Spring容器对应的配置类</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;MyConfig.class&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt;[] getServletConfigClasses() &#123;</span><br><span class="line">        <span class="comment">//返回SpringMvc容器对应的配置类</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;MyMvcConfig.class&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> String[] getServletMappings() &#123;</span><br><span class="line">        <span class="comment">//返回DispatcherServlet的拦截路径，在ServletRegistration.Dynamic的addMapping方法里面用到</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/&quot;</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>WebInitializer 的 onStartup 的方法在它的父类 AbstractDispatcherServletInitializer 中实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractDispatcherServletInitializer</span> <span class="keyword">extends</span> <span class="title class_">AbstractContextLoaderInitializer</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_SERVLET_NAME</span> <span class="operator">=</span> <span class="string">&quot;dispatcher&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">//WebInitializer的onStartup的方法在它的父类AbstractDispatcherServletInitializer中实现</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStartup</span><span class="params">(ServletContext servletContext)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">    <span class="comment">//调用父类的AbstractContextLoaderInitializer的onStartup方法</span></span><br><span class="line">    <span class="built_in">super</span>.onStartup(servletContext);</span><br><span class="line">    <span class="comment">//主要的作用是创建SpringMvc容器并且将DispatcherServlet注册到Servlet容器中</span></span><br><span class="line">    registerDispatcherServlet(servletContext);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">registerDispatcherServlet</span><span class="params">(ServletContext servletContext)</span> &#123;</span><br><span class="line">    <span class="comment">//默认的名字是dispatcher</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">servletName</span> <span class="operator">=</span> getServletName();</span><br><span class="line">    Assert.hasLength(servletName, <span class="string">&quot;getServletName() must not return null or empty&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//createServletApplicationContext这个方法在其子类AbstractAnnotationConfigDispatcherServletInitializer中实现，起作用是创建并且返回spirngMvc容器</span></span><br><span class="line">    <span class="type">WebApplicationContext</span> <span class="variable">servletAppContext</span> <span class="operator">=</span> createServletApplicationContext();</span><br><span class="line">    Assert.notNull(servletAppContext, <span class="string">&quot;createServletApplicationContext() must not return null&quot;</span>);</span><br><span class="line">    <span class="comment">//createDispatcherServlet创建并且返回DispatcherServlet实例</span></span><br><span class="line">    <span class="type">FrameworkServlet</span> <span class="variable">dispatcherServlet</span> <span class="operator">=</span> createDispatcherServlet(servletAppContext);</span><br><span class="line">    Assert.notNull(dispatcherServlet, <span class="string">&quot;createDispatcherServlet(WebApplicationContext) must not return null&quot;</span>);</span><br><span class="line">    dispatcherServlet.setContextInitializers(getServletApplicationContextInitializers());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将DispatcherServlet注册到Servlet容器中</span></span><br><span class="line">    ServletRegistration.<span class="type">Dynamic</span> <span class="variable">registration</span> <span class="operator">=</span> servletContext.addServlet(servletName, dispatcherServlet);</span><br><span class="line">    <span class="keyword">if</span> (registration == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Failed to register servlet with name &#x27;&quot;</span> + servletName + <span class="string">&quot;&#x27;. &quot;</span> +</span><br><span class="line">          <span class="string">&quot;Check if there is another servlet registered under the same name.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//这里的代码的作用和在web.xml配置的&lt;load-on-startup&gt;1&lt;/load-on-startup&gt;一样</span></span><br><span class="line">    registration.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">//这里getServletMappings方法调用的就是是我在WebInitializer实现的getServletMappings方法</span></span><br><span class="line">    registration.addMapping(getServletMappings());</span><br><span class="line">    registration.setAsyncSupported(isAsyncSupported());</span><br><span class="line"></span><br><span class="line">    Filter[] filters = getServletFilters();</span><br><span class="line">    <span class="keyword">if</span> (!ObjectUtils.isEmpty(filters)) &#123;</span><br><span class="line">      <span class="keyword">for</span> (Filter filter : filters) &#123;</span><br><span class="line">        <span class="comment">//将针对DispatcherServlet的Filter注册到Servlet容器中</span></span><br><span class="line">        registerServletFilter(servletContext, filter);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//用户可以重写这个方法对DispatcherServlet做一些配置，例如我想设置一下DispatcherServlet的加载顺序就重写该方法在里面加一个语句registration.setLoadOnStartup(2);</span></span><br><span class="line">    customizeRegistration(registration);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> String <span class="title function_">getServletName</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> DEFAULT_SERVLET_NAME;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">abstract</span> WebApplicationContext <span class="title function_">createServletApplicationContext</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//创建并且返回DispatcherServlet实例</span></span><br><span class="line">  <span class="keyword">protected</span> FrameworkServlet <span class="title function_">createDispatcherServlet</span><span class="params">(WebApplicationContext servletAppContext)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DispatcherServlet</span>(servletAppContext);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Nullable</span></span><br><span class="line">  <span class="keyword">protected</span> ApplicationContextInitializer&lt;?&gt;[] getServletApplicationContextInitializers() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">abstract</span> String[] getServletMappings();</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Nullable</span></span><br><span class="line">  <span class="keyword">protected</span> Filter[] getServletFilters() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> FilterRegistration.Dynamic <span class="title function_">registerServletFilter</span><span class="params">(ServletContext servletContext, Filter filter)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">filterName</span> <span class="operator">=</span> Conventions.getVariableName(filter);</span><br><span class="line">    <span class="type">Dynamic</span> <span class="variable">registration</span> <span class="operator">=</span> servletContext.addFilter(filterName, filter);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (registration == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="type">int</span> <span class="variable">counter</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">while</span> (registration == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (counter == <span class="number">100</span>) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Failed to register filter with name &#x27;&quot;</span> + filterName + <span class="string">&quot;&#x27;. &quot;</span> +</span><br><span class="line">              <span class="string">&quot;Check if there is another filter registered under the same name.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        registration = servletContext.addFilter(filterName + <span class="string">&quot;#&quot;</span> + counter, filter);</span><br><span class="line">        counter++;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    registration.setAsyncSupported(isAsyncSupported());</span><br><span class="line">    registration.addMappingForServletNames(getDispatcherTypes(), <span class="literal">false</span>, getServletName());</span><br><span class="line">    <span class="keyword">return</span> registration;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> EnumSet&lt;DispatcherType&gt; <span class="title function_">getDispatcherTypes</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (isAsyncSupported() ?</span><br><span class="line">        EnumSet.of(DispatcherType.REQUEST, DispatcherType.FORWARD, DispatcherType.INCLUDE, DispatcherType.ASYNC) :</span><br><span class="line">        EnumSet.of(DispatcherType.REQUEST, DispatcherType.FORWARD, DispatcherType.INCLUDE));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isAsyncSupported</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//用户可以重写这个方法对DispatcherServlet做一些配置</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">customizeRegistration</span><span class="params">(ServletRegistration.Dynamic registration)</span> &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AbstractDispatcherServletInitializer 的父类 AbstractContextLoaderInitializer 的代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractContextLoaderInitializer</span> <span class="keyword">implements</span> <span class="title class_">WebApplicationInitializer</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">Log</span> <span class="variable">logger</span> <span class="operator">=</span> LogFactory.getLog(getClass());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">//在子类AbstractDispatcherServletInitializer中通过super.onStartup(servletContext)调用该方法</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStartup</span><span class="params">(ServletContext servletContext)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">    <span class="comment">//创建Spring容器和Servlet容器的监听器，并且将监听器注册到Servlet容器中</span></span><br><span class="line">    registerContextLoaderListener(servletContext);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">registerContextLoaderListener</span><span class="params">(ServletContext servletContext)</span> &#123;</span><br><span class="line">    <span class="comment">//createRootApplicationContext这个方法在其子类AbstractAnnotationConfigDispatcherServletInitializer中实现，这个方法创建并且返回一个spring容器</span></span><br><span class="line">    <span class="type">WebApplicationContext</span> <span class="variable">rootAppContext</span> <span class="operator">=</span> createRootApplicationContext();</span><br><span class="line">    <span class="keyword">if</span> (rootAppContext != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">//创建Servlet容器的监听器（ContextLoaderListener实现了ServletContextListener），并且将Spring容器的实例作为参数传入</span></span><br><span class="line">      <span class="type">ContextLoaderListener</span> <span class="variable">listener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ContextLoaderListener</span>(rootAppContext);</span><br><span class="line">      listener.setContextInitializers(getRootApplicationContextInitializers());</span><br><span class="line">      <span class="comment">//将监听器注册到servlet容器中</span></span><br><span class="line">      servletContext.addListener(listener);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      logger.debug(<span class="string">&quot;No ContextLoaderListener registered, as &quot;</span> +</span><br><span class="line">          <span class="string">&quot;createRootApplicationContext() did not return an application context&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Nullable</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">abstract</span> WebApplicationContext <span class="title function_">createRootApplicationContext</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Nullable</span></span><br><span class="line">  <span class="keyword">protected</span> ApplicationContextInitializer&lt;?&gt;[] getRootApplicationContextInitializers() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>AbstractDispatcherServletInitializer 的 createServletApplicationContext 方法和 AbstractContextLoaderInitializer 的 createRootApplicationContext 方法都是在子类 AbstractAnnotationConfigDispatcherServletInitializer 中实现的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractAnnotationConfigDispatcherServletInitializer</span></span><br><span class="line">    <span class="keyword">extends</span> <span class="title class_">AbstractDispatcherServletInitializer</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="meta">@Nullable</span></span><br><span class="line">  <span class="keyword">protected</span> WebApplicationContext <span class="title function_">createRootApplicationContext</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//getRootConfigClasses这个方法在我实现的子类WebInitializer中有实现了，返回的是Spring容器的配置类，在这个案例就是MyConfig.class</span></span><br><span class="line">    Class&lt;?&gt;[] configClasses = getRootConfigClasses();</span><br><span class="line">    <span class="keyword">if</span> (!ObjectUtils.isEmpty(configClasses)) &#123;</span><br><span class="line">      <span class="comment">//创建Spring容器实例</span></span><br><span class="line">      <span class="type">AnnotationConfigWebApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigWebApplicationContext</span>();</span><br><span class="line">      <span class="comment">//将配置类注册到容器中</span></span><br><span class="line">      context.register(configClasses);</span><br><span class="line">      <span class="keyword">return</span> context;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> WebApplicationContext <span class="title function_">createServletApplicationContext</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//创建SpringMvc容器</span></span><br><span class="line">    <span class="type">AnnotationConfigWebApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigWebApplicationContext</span>();</span><br><span class="line">    <span class="comment">//getServletConfigClasses这个方法在我实现的子类WebInitializer中有实现了，返回的是SpringMvc容器的配置类，在这个案例就是MyMvcConfig.class</span></span><br><span class="line">    Class&lt;?&gt;[] configClasses = getServletConfigClasses();</span><br><span class="line">    <span class="keyword">if</span> (!ObjectUtils.isEmpty(configClasses)) &#123;</span><br><span class="line">      context.register(configClasses);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> context;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Nullable</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">abstract</span> Class&lt;?&gt;[] getRootConfigClasses();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Nullable</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">abstract</span> Class&lt;?&gt;[] getServletConfigClasses();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看完上面代码和注释可以看出 WebInitializer 的 onStartup 方法其实主要做了几件事：</p>
<ol>
<li>创建 Spring 容器，获取 Spring 容器对应的配置类并且把配置类注册到 Spring 容器，将 Spring 容器作为参数传入创建 Servlet 容器的监听器（ContextLoaderListener 实现了 ServletContextListener），将监听器注册到 servlet 容器中</li>
<li>创建 SpringMvc 容器，获取 SpringMvc 容器对应的配置类并且把配置类注册到 SpringMvc 容器，将 SpringMvc 容器作为参数传入创建 DispatcherServlet 实例，并且将 DispatcherServlet 实例注册 Servlet 容器中</li>
</ol>
<p>之后的流程就和上面使用 xml 的方式差不多，在 Servelt 容器监听器 ContextLoaderListener 里的 contextInitialized 方法里面对 Spring 容器进初始化等一些操作，并且将 Spring 容器保存到 servlet 容器中，SpringMvc 容器也是在 Servlet 的 init 方法里面对 SpringMvc 容器进行初始化等一些操作，最终将 SpringMvc 容保存到 servlet 容器中。这里只是简单的描述一下，具体的流程可以按照上面 xml 里面分析的流程去调试代码，这样会比较清晰而且会有不错的收获。</p>
<h4 id="SpringBoot-是如何加载-Servlet-的"><a href="#SpringBoot-是如何加载-Servlet-的" class="headerlink" title="SpringBoot 是如何加载 Servlet 的"></a>SpringBoot 是如何加载 Servlet 的</h4><p>SpringBoot 加载 servlet 和 filter 的方式和前面说的使用 web,xml 和使用 SPI 来加载 ServletContainerInitializer 实现类的方法都不同。下面先来看看在 SpringBoot 中 servlet 和 filter 的几种注册方式</p>
<h5 id="注册方式一：servlet3-0-注解-ServletComponentScan"><a href="#注册方式一：servlet3-0-注解-ServletComponentScan" class="headerlink" title="注册方式一：servlet3.0 注解 +@ServletComponentScan"></a>注册方式一：servlet3.0 注解 +@ServletComponentScan</h5><p>SpringBoot 兼容 servlet3.0，可以使用一系列以 Web*开头的注解:@Servlet、@Filter、@WebListener</p>
<p>使用 Servlet3.0 提供的@Servlet 和@WebFilter 注解+@ServletComponentScan 注解</p>
<p>MyFilter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//里面的initParams的参数类似于在web.xml中filter标签里面的init-param标签里设置的一些初始化参数，这些参数可以通过getInitParameter方法获取</span></span><br><span class="line"><span class="meta">@WebFilter(value = &quot;/myServlet&quot;,initParams = &#123;@WebInitParam(name = &quot;filterName&quot;,value = &quot;myFilter&quot;),@WebInitParam(name = &quot;msg&quot;,value = &quot;被我过滤了&quot;)&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyFilter</span> <span class="keyword">extends</span> <span class="title class_">HttpFilter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        response.setContentType(<span class="string">&quot;text/html;charset=utf-8&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> getInitParameter(<span class="string">&quot;filterName&quot;</span>) +</span><br><span class="line">                <span class="string">&quot;:&quot;</span> +</span><br><span class="line">                getInitParameter(<span class="string">&quot;msg&quot;</span>);</span><br><span class="line">        response.getOutputStream().write(msg.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">        response.getOutputStream().write(<span class="string">&quot;&lt;br&gt;&quot;</span>.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">        chain.doFilter(request,response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MyServlet</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebServlet(value = &quot;/myServlet&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        resp.getOutputStream().write(<span class="string">&quot;myServlet:哈喽啊！！！&quot;</span>.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是几种方式中最为简洁的方式，如果真的有特殊需求，需要在 springboot 下注册 servlet，filter，可以采用这样的方式，比较直观。</p>
<h5 id="注册方式二：RegistrationBean"><a href="#注册方式二：RegistrationBean" class="headerlink" title="注册方式二：RegistrationBean"></a>注册方式二：RegistrationBean</h5><p>MyConfig</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ServletRegistrationBean&lt;HelloWorldServlet&gt; <span class="title function_">helloWorldServlet</span><span class="params">()</span> &#123;</span><br><span class="line">        ServletRegistrationBean&lt;HelloWorldServlet&gt; helloWorldServlet = <span class="keyword">new</span> <span class="title class_">ServletRegistrationBean</span>&lt;&gt;();</span><br><span class="line">        helloWorldServlet.addUrlMappings(<span class="string">&quot;/hello&quot;</span>);</span><br><span class="line">        helloWorldServlet.setServlet(<span class="keyword">new</span> <span class="title class_">HelloWorldServlet</span>());</span><br><span class="line">        <span class="keyword">return</span> helloWorldServlet;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> FilterRegistrationBean&lt;HelloWorldFilter&gt; <span class="title function_">helloWorldFilter</span><span class="params">()</span> &#123;</span><br><span class="line">        FilterRegistrationBean&lt;HelloWorldFilter&gt; helloWorldFilter = <span class="keyword">new</span> <span class="title class_">FilterRegistrationBean</span>&lt;&gt;();</span><br><span class="line">        helloWorldFilter.addUrlPatterns(<span class="string">&quot;/hello/*&quot;</span>);</span><br><span class="line">        helloWorldFilter.setFilter(<span class="keyword">new</span> <span class="title class_">HelloWorldFilter</span>());</span><br><span class="line">        <span class="keyword">return</span> helloWorldFilter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>HelloWorldFilter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldFilter</span> <span class="keyword">extends</span> <span class="title class_">HttpFilter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;helloWorldFilter:被我拦截了&quot;</span>);</span><br><span class="line">        chain.doFilter(request,response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>HelloWorldServlet</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        resp.setContentType(<span class="string">&quot;text/html;charset=utf-8&quot;</span>);</span><br><span class="line">        resp.getOutputStream().write(<span class="string">&quot;helloWorldServlet:被我的处理了&quot;</span>.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ServletRegistrationBean 和 FilterRegistrationBean 都继承自 RegistrationBean ，RegistrationBean 是 springboot 中广泛应用的一个注册类，负责把 servlet，filter，listener 给容器化，使他们被 spring 托管，并且完成自身对 web 容器的注册。这种注册方式也值得推崇。</p>
<p><img src="https://cdn.jsdelivr.net/gh/OUZHANBO/pics/img/b2318c2a-df88-4880-a8af-ffd0e6fc58b0.png" alt="图片丢失" title="Registration的继承关系"></p>
<p>RegistrationBean 这个类的几个子类 ServletRegistrationBean、FilterRegistrationBean、ServletListenerRegistrationBean 的作用分别是帮助容器注册 servlet、filter、listener，DelegatingFilterProxyRegistrationBean 这个是用在 SpringSecurity 里的，这笔记力线不管，之后学习 SpringSecurity 的时候才会用到。在这里还需要留意 RegistrationBean 这个类实现了 ServletContextInitializer 接口（注意他和上面说的 ServletContainerInitializer 不是同一个东西），这个接口是一个核心接口，后面还会提到，这里先混个眼熟。</p>
<h5 id="SpringBoot-内置-tomcat-容器加载-servlet-源码分析"><a href="#SpringBoot-内置-tomcat-容器加载-servlet-源码分析" class="headerlink" title="SpringBoot 内置 tomcat 容器加载 servlet 源码分析"></a>SpringBoot 内置 tomcat 容器加载 servlet 源码分析</h5><p><img src="https://cdn.jsdelivr.net/gh/OUZHANBO/pics/img/44413ff6-b032-42f9-96c9-d2caf276d357.jpg" alt="图片丢失" title="TomcatStarter"></p>
<p>SpringBoot 使用内置 tomcat 的情况下没有使用前面说到的 SpringServletContainerInitializer，而是使用 ServletContainerInitializer 的另一个实现类 TomcatStarter，但是这个 TomcatStarter 的调用并依赖不依赖于 servlet3.0 规范和 SPI，它走的是另外一套新的逻辑，在 Spring github 的 issue 中作者说了:<a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-boot/issues/321">https://github.com/spring-projects/spring-boot/issues/321</a></p>
<blockquote>
<p>This was actually an intentional design decision. The search algorithm used by the containers was problematic. It also causes problems when you want to develop an executable WAR as you often want a <code>javax.servlet.ServletContainerInitializer</code> for the WAR that is not executed when you run <code>java -jar</code>.</p>
<p>See the <code>org.springframework.boot.context.embedded.ServletContextInitializer</code> for an option that works with Spring Beans.</p>
</blockquote>
<p>springboot 这么做是有意而为之。springboot 考虑到了如下的问题，我们在使用 springboot 时，开发阶段一般都是使用内嵌 tomcat 容器，但部署时却存在两种选择：一种是打成 jar 包，使用 java -jar 的方式运行；另一种是打成 war 包，交给外置容器去运行。前者就会导致容器搜索算法出现问题，因为这是 jar 包的运行策略，不会按照 servlet3.0 的策略去加载 ServletContainerInitializer！最后作者还提供了一个替代选项：ServletContextInitializer，前文还提到 RegistrationBean 实现了 ServletContextInitializer 接口。</p>
<p>在 TomcatStarter 中的 ServletContextInitializer[] initializers 是 springboot 注册 servlet，filter，listener 的关键，先看看 TomcatStarter 的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TomcatStarter</span> <span class="keyword">implements</span> <span class="title class_">ServletContainerInitializer</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Log</span> <span class="variable">logger</span> <span class="operator">=</span> LogFactory.getLog(TomcatStarter.class);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//存放实现了ServletContextInitializer接口的类的实例，例如ServletRegistrationBean、FilterRegistrationBean、ServletListenerRegistrationBean</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ServletContextInitializer[] initializers;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> Exception startUpException;</span><br><span class="line"></span><br><span class="line">  TomcatStarter(ServletContextInitializer[] initializers) &#123;</span><br><span class="line">    <span class="built_in">this</span>.initializers = initializers;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStartup</span><span class="params">(Set&lt;Class&lt;?&gt;&gt; classes, ServletContext servletContext)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//这里获取到的ServletContextInitializer的实例并不是我们上面说的RegistrationBean的子类实例</span></span><br><span class="line">      <span class="keyword">for</span> (ServletContextInitializer initializer : <span class="built_in">this</span>.initializers) &#123;</span><br><span class="line">        initializer.onStartup(servletContext);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">      <span class="built_in">this</span>.startUpException = ex;</span><br><span class="line">      <span class="comment">// Prevent Tomcat from logging and re-throwing when we know we can</span></span><br><span class="line">      <span class="comment">// deal with it in the main thread, but log for information here.</span></span><br><span class="line">      <span class="keyword">if</span> (logger.isErrorEnabled()) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;Error starting Tomcat context. Exception: &quot;</span> + ex.getClass().getName() + <span class="string">&quot;. Message: &quot;</span></span><br><span class="line">            + ex.getMessage());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以打断点调试一下，会发现在 TomcatStarter 里面的 ServletContextInitializer[] initializers 里存放的并不是我们上面说的 RegistrationBean 的子类的实例，而是三个用 lambda 表达式实现的匿名内部类的实例，其中在 ServletWebServerApplicationContext 中实现的匿名内部类是是获取 RegistrationBean 子类的实例的核心</p>
<p><img src="https://cdn.jsdelivr.net/gh/OUZHANBO/pics/img/32a7d016-e2d4-4bbe-8aaf-3210e85b4370.jpg" alt="图片丢失" title="TomcatStarter的onStartup方法调试截图"></p>
<p>想知道这个 ServletWebServerApplicationContext 的实例是在哪被放入 TomcatStarter 中的就要从 main 方法开始一路深入，到 ServletWebServerApplicationContext.createWebServer 前的调用逻辑大概是下面这样，具体自己调试看下比较清楚。</p>
<p>SpringApplication.run =&gt; SpringApplication.refreshContext =&gt; SpringApplication.refresh =&gt; AbstractApplicationContext.refresh</p>
<p>=&gt; ServletWebServerApplicationContext.onRefresh =&gt; ServletWebServerApplicationContext.createWebServer</p>
<p>ServletWebServerApplicationContext 中 createWebServer 的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">createWebServer</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">WebServer</span> <span class="variable">webServer</span> <span class="operator">=</span> <span class="built_in">this</span>.webServer;</span><br><span class="line">  <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> getServletContext();</span><br><span class="line">  <span class="keyword">if</span> (webServer == <span class="literal">null</span> &amp;&amp; servletContext == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="type">ServletWebServerFactory</span> <span class="variable">factory</span> <span class="operator">=</span> getWebServerFactory();</span><br><span class="line">    <span class="comment">//getWebServer方法和getSelfInitializer方法是两个关键的的方法，我们后面一个个看</span></span><br><span class="line">    <span class="built_in">this</span>.webServer = factory.getWebServer(getSelfInitializer());</span><br><span class="line">    getBeanFactory().registerSingleton(<span class="string">&quot;webServerGracefulShutdown&quot;</span>,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">WebServerGracefulShutdownLifecycle</span>(<span class="built_in">this</span>.webServer));</span><br><span class="line">    getBeanFactory().registerSingleton(<span class="string">&quot;webServerStartStop&quot;</span>,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">WebServerStartStopLifecycle</span>(<span class="built_in">this</span>, <span class="built_in">this</span>.webServer));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (servletContext != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      getSelfInitializer().onStartup(servletContext);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (ServletException ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ApplicationContextException</span>(<span class="string">&quot;Cannot initialize servlet context&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  initPropertySources();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>getWebServer 方法的代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> WebServer <span class="title function_">getWebServer</span><span class="params">(ServletContextInitializer... initializers)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.disableMBeanRegistry) &#123;</span><br><span class="line">    Registry.disableRegistry();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//创建tomcat</span></span><br><span class="line">  <span class="type">Tomcat</span> <span class="variable">tomcat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Tomcat</span>();</span><br><span class="line">  <span class="type">File</span> <span class="variable">baseDir</span> <span class="operator">=</span> (<span class="built_in">this</span>.baseDirectory != <span class="literal">null</span>) ? <span class="built_in">this</span>.baseDirectory : createTempDir(<span class="string">&quot;tomcat&quot;</span>);</span><br><span class="line">  tomcat.setBaseDir(baseDir.getAbsolutePath());</span><br><span class="line">  <span class="type">Connector</span> <span class="variable">connector</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Connector</span>(<span class="built_in">this</span>.protocol);</span><br><span class="line">  connector.setThrowOnFailure(<span class="literal">true</span>);</span><br><span class="line">  tomcat.getService().addConnector(connector);</span><br><span class="line">  customizeConnector(connector);</span><br><span class="line">  tomcat.setConnector(connector);</span><br><span class="line">  tomcat.getHost().setAutoDeploy(<span class="literal">false</span>);</span><br><span class="line">  configureEngine(tomcat.getEngine());</span><br><span class="line">  <span class="keyword">for</span> (Connector additionalConnector : <span class="built_in">this</span>.additionalTomcatConnectors) &#123;</span><br><span class="line">    tomcat.getService().addConnector(additionalConnector);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//在这个方法里面调用了configureContext方法，就是configureContext这个方法创建了TomcatStarter并且将前面说的那几个通过lambda表达式实现的匿名内部类的实例赛道TomcatStarter中的</span></span><br><span class="line">  prepareContext(tomcat.getHost(), initializers);</span><br><span class="line">  <span class="keyword">return</span> getTomcatWebServer(tomcat);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>prepareContext 的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">prepareContext</span><span class="params">(Host host, ServletContextInitializer[] initializers)</span> &#123;</span><br><span class="line">  <span class="type">File</span> <span class="variable">documentRoot</span> <span class="operator">=</span> getValidDocumentRoot();</span><br><span class="line">  <span class="type">TomcatEmbeddedContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TomcatEmbeddedContext</span>();</span><br><span class="line">  <span class="keyword">if</span> (documentRoot != <span class="literal">null</span>) &#123;</span><br><span class="line">    context.setResources(<span class="keyword">new</span> <span class="title class_">LoaderHidingResourceRoot</span>(context));</span><br><span class="line">  &#125;</span><br><span class="line">  context.setName(getContextPath());</span><br><span class="line">  context.setDisplayName(getDisplayName());</span><br><span class="line">  context.setPath(getContextPath());</span><br><span class="line">  <span class="type">File</span> <span class="variable">docBase</span> <span class="operator">=</span> (documentRoot != <span class="literal">null</span>) ? documentRoot : createTempDir(<span class="string">&quot;tomcat-docbase&quot;</span>);</span><br><span class="line">  context.setDocBase(docBase.getAbsolutePath());</span><br><span class="line">  context.addLifecycleListener(<span class="keyword">new</span> <span class="title class_">FixContextListener</span>());</span><br><span class="line">  context.setParentClassLoader((<span class="built_in">this</span>.resourceLoader != <span class="literal">null</span>) ? <span class="built_in">this</span>.resourceLoader.getClassLoader()</span><br><span class="line">      : ClassUtils.getDefaultClassLoader());</span><br><span class="line">  resetDefaultLocaleMapping(context);</span><br><span class="line">  addLocaleMappings(context);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    context.setCreateUploadTargets(<span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (NoSuchMethodError ex) &#123;</span><br><span class="line">    <span class="comment">// Tomcat is &lt; 8.5.39. Continue.</span></span><br><span class="line">  &#125;</span><br><span class="line">  configureTldPatterns(context);</span><br><span class="line">  <span class="type">WebappLoader</span> <span class="variable">loader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebappLoader</span>();</span><br><span class="line">  loader.setLoaderClass(TomcatEmbeddedWebappClassLoader.class.getName());</span><br><span class="line">  loader.setDelegate(<span class="literal">true</span>);</span><br><span class="line">  context.setLoader(loader);</span><br><span class="line">  <span class="keyword">if</span> (isRegisterDefaultServlet()) &#123;</span><br><span class="line">    addDefaultServlet(context);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (shouldRegisterJspServlet()) &#123;</span><br><span class="line">    addJspServlet(context);</span><br><span class="line">    addJasperInitializer(context);</span><br><span class="line">  &#125;</span><br><span class="line">  context.addLifecycleListener(<span class="keyword">new</span> <span class="title class_">StaticResourceConfigurer</span>(context));</span><br><span class="line">  <span class="comment">//这个方法可以自己看下，可以看到除了我们关键的ServletWebServerApplicationContext中匿名实现的ServletContextInitializer类的实例外，剩下的两个ServletContextInitializer实例就是在这里放入数组</span></span><br><span class="line">  ServletContextInitializer[] initializersToUse = mergeInitializers(initializers);</span><br><span class="line">  host.addChild(context);</span><br><span class="line">  <span class="comment">//在这个方法里创建TomcatStarter并且将上面initializersToUse数组中的ServletContextInitializer实例放入TomcatStarter中的ervletContextInitializer[] initializers</span></span><br><span class="line">  configureContext(context, initializersToUse);</span><br><span class="line">  postProcessContext(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>configureContext 的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configureContext</span><span class="params">(Context context, ServletContextInitializer[] initializers)</span> &#123;</span><br><span class="line">  <span class="comment">//创建TomcatStarter，并且将ServletContextInitializer实例放入其中</span></span><br><span class="line">  <span class="type">TomcatStarter</span> <span class="variable">starter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TomcatStarter</span>(initializers);</span><br><span class="line">  <span class="keyword">if</span> (context <span class="keyword">instanceof</span> TomcatEmbeddedContext) &#123;</span><br><span class="line">    <span class="type">TomcatEmbeddedContext</span> <span class="variable">embeddedContext</span> <span class="operator">=</span> (TomcatEmbeddedContext) context;</span><br><span class="line">    embeddedContext.setStarter(starter);</span><br><span class="line">    embeddedContext.setFailCtxIfServletStartFails(<span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//将TomcatStarter通过addServletContainerInitializer方法放入servlet容器中，之后实现了ServletContainerInitializer的TomcatStarter的onStartup方法被调用会在StandardContext类中被调用（上面贴过源码，忘了可以回去看看）</span></span><br><span class="line">  context.addServletContainerInitializer(starter, NO_CLASSES);</span><br><span class="line">  <span class="keyword">for</span> (LifecycleListener lifecycleListener : <span class="built_in">this</span>.contextLifecycleListeners) &#123;</span><br><span class="line">    context.addLifecycleListener(lifecycleListener);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (Valve valve : <span class="built_in">this</span>.contextValves) &#123;</span><br><span class="line">    context.getPipeline().addValve(valve);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (ErrorPage errorPage : getErrorPages()) &#123;</span><br><span class="line">    org.apache.tomcat.util.descriptor.web.<span class="type">ErrorPage</span> <span class="variable">tomcatErrorPage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">org</span>.apache.tomcat.util.descriptor.web.ErrorPage();</span><br><span class="line">    tomcatErrorPage.setLocation(errorPage.getPath());</span><br><span class="line">    tomcatErrorPage.setErrorCode(errorPage.getStatusCode());</span><br><span class="line">    tomcatErrorPage.setExceptionType(errorPage.getExceptionName());</span><br><span class="line">    context.addErrorPage(tomcatErrorPage);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (MimeMappings.Mapping mapping : getMimeMappings()) &#123;</span><br><span class="line">    context.addMimeMapping(mapping.getExtension(), mapping.getMimeType());</span><br><span class="line">  &#125;</span><br><span class="line">  configureSession(context);</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">DisableReferenceClearingContextCustomizer</span>().customize(context);</span><br><span class="line">  <span class="keyword">for</span> (TomcatContextCustomizer customizer : <span class="built_in">this</span>.tomcatContextCustomizers) &#123;</span><br><span class="line">    customizer.customize(context);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再看下 getSelfInitializer 方法的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> org.springframework.boot.web.servlet.ServletContextInitializer <span class="title function_">getSelfInitializer</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">//这里用了java8的方法引用的写法是对lambda表达式的简写，等价于(servletContext)-&gt;this.selfInitialize(servletContext)</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">this</span>::selfInitialize;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>selfInitialize 方法的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">selfInitialize</span><span class="params">(ServletContext servletContext)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">  prepareWebApplicationContext(servletContext);</span><br><span class="line">  registerApplicationScope(servletContext);</span><br><span class="line">  WebApplicationContextUtils.registerEnvironmentBeans(getBeanFactory(), servletContext);</span><br><span class="line">  <span class="keyword">for</span> (ServletContextInitializer beans : getServletContextInitializerBeans()) &#123;</span><br><span class="line">    <span class="comment">//这里的beans有我们关心的RegistrationBean的实例</span></span><br><span class="line">    beans.onStartup(servletContext);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>getServletContextInitializerBeans 方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Collection&lt;ServletContextInitializer&gt; <span class="title function_">getServletContextInitializerBeans</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">//ServletContextInitializerBeans继承了Collection，所以它实现了iterator()方法可以被遍历</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServletContextInitializerBeans</span>(getBeanFactory());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ServletContextInitializerBeans 的 iterator()方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Iterator&lt;ServletContextInitializer&gt; <span class="title function_">iterator</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">//sortedList的声明List&lt;ServletContextInitializer&gt; sortedList</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">this</span>.sortedList.iterator();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ServletContextInitializerBeans 的构造方法代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ServletContextInitializerBeans</span><span class="params">(ListableBeanFactory beanFactory,</span></span><br><span class="line"><span class="params">    Class&lt;? extends ServletContextInitializer&gt;... initializerTypes)</span> &#123;</span><br><span class="line">  <span class="built_in">this</span>.initializers = <span class="keyword">new</span> <span class="title class_">LinkedMultiValueMap</span>&lt;&gt;();</span><br><span class="line">  <span class="built_in">this</span>.initializerTypes = (initializerTypes.length != <span class="number">0</span>) ? Arrays.asList(initializerTypes)</span><br><span class="line">      : Collections.singletonList(ServletContextInitializer.class);</span><br><span class="line">  <span class="comment">//将ServletContextInitializer的实例添加到MultiValueMap&lt;Class&lt;?&gt;, ServletContextInitializer&gt; initializers中</span></span><br><span class="line">  addServletContextInitializerBeans(beanFactory);</span><br><span class="line">  addAdaptableBeans(beanFactory);</span><br><span class="line">   <span class="comment">//下面的逻辑最终会将initializers里面的ServletContextInitializer的实例保存到this.sortedList中</span></span><br><span class="line">  List&lt;ServletContextInitializer&gt; sortedInitializers = <span class="built_in">this</span>.initializers.values().stream()</span><br><span class="line">      .flatMap((value) -&gt; value.stream().sorted(AnnotationAwareOrderComparator.INSTANCE))</span><br><span class="line">      .collect(Collectors.toList());</span><br><span class="line">  <span class="built_in">this</span>.sortedList = Collections.unmodifiableList(sortedInitializers);</span><br><span class="line">  logMappings(<span class="built_in">this</span>.initializers);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>addServletContextInitializerBeans 方法的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addServletContextInitializerBeans</span><span class="params">(ListableBeanFactory beanFactory)</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (Class&lt;? <span class="keyword">extends</span> <span class="title class_">ServletContextInitializder</span>&gt; initializerType : <span class="built_in">this</span>.initializerTypes) &#123;</span><br><span class="line">    <span class="comment">//通过beanFactory获取在已经注册到Spring容器中的ServletContextInitializer实例，在MyConfig中注册的RegistrationBean在这里就可以获取到</span></span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;String, ? <span class="keyword">extends</span> <span class="title class_">ServletContextInitializer</span>&gt; initializerBean : getOrderedBeansOfType(beanFactory,</span><br><span class="line">        initializerType)) &#123;</span><br><span class="line">      <span class="comment">//将ServletContextInitializer的实例添加到MultiValueMap&lt;Class&lt;?&gt;, ServletContextInitializer&gt; initializers中</span></span><br><span class="line">      addServletContextInitializerBean(initializerBean.getKey(), initializerBean.getValue(), beanFactory);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>addServletContextInitializerBean(String beanName, ServletContextInitializer initializer,ListableBeanFactory beanFactory)的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addServletContextInitializerBean</span><span class="params">(String beanName, ServletContextInitializer initializer,</span></span><br><span class="line"><span class="params">    ListableBeanFactory beanFactory)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (initializer <span class="keyword">instanceof</span> ServletRegistrationBean) &#123;</span><br><span class="line">    <span class="type">Servlet</span> <span class="variable">source</span> <span class="operator">=</span> ((ServletRegistrationBean&lt;?&gt;) initializer).getServlet();</span><br><span class="line">    <span class="comment">//在这个方法里才真正将ServletContextInitializer的实例添加到MultiValueMap&lt;Class&lt;?&gt;, ServletContextInitializer&gt; initializers中</span></span><br><span class="line">    addServletContextInitializerBean(Servlet.class, beanName, initializer, beanFactory, source);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (initializer <span class="keyword">instanceof</span> FilterRegistrationBean) &#123;</span><br><span class="line">    <span class="type">Filter</span> <span class="variable">source</span> <span class="operator">=</span> ((FilterRegistrationBean&lt;?&gt;) initializer).getFilter();</span><br><span class="line">    addServletContextInitializerBean(Filter.class, beanName, initializer, beanFactory, source);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (initializer <span class="keyword">instanceof</span> DelegatingFilterProxyRegistrationBean) &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">source</span> <span class="operator">=</span> ((DelegatingFilterProxyRegistrationBean) initializer).getTargetBeanName();</span><br><span class="line">    addServletContextInitializerBean(Filter.class, beanName, initializer, beanFactory, source);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (initializer <span class="keyword">instanceof</span> ServletListenerRegistrationBean) &#123;</span><br><span class="line">    <span class="type">EventListener</span> <span class="variable">source</span> <span class="operator">=</span> ((ServletListenerRegistrationBean&lt;?&gt;) initializer).getListener();</span><br><span class="line">    addServletContextInitializerBean(EventListener.class, beanName, initializer, beanFactory, source);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    addServletContextInitializerBean(ServletContextInitializer.class, beanName, initializer, beanFactory,</span><br><span class="line">        initializer);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>addServletContextInitializerBean(Class&lt;?&gt; type, String beanName, ServletContextInitializer initializer,ListableBeanFactory beanFactory, Object source)的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addServletContextInitializerBean</span><span class="params">(Class&lt;?&gt; type, String beanName, ServletContextInitializer initializer,</span></span><br><span class="line"><span class="params">    ListableBeanFactory beanFactory, Object source)</span> &#123;</span><br><span class="line">  <span class="comment">//将ServletContextInitializer的实例添加到MultiValueMap&lt;Class&lt;?&gt;, ServletContextInitializer&gt; initializers中</span></span><br><span class="line">  <span class="built_in">this</span>.initializers.add(type, initializer);</span><br><span class="line">  <span class="keyword">if</span> (source != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Mark the underlying source as seen in case it wraps an existing bean</span></span><br><span class="line">    <span class="built_in">this</span>.seen.add(source);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">resourceDescription</span> <span class="operator">=</span> getResourceDescription(beanName, beanFactory);</span><br><span class="line">    <span class="type">int</span> <span class="variable">order</span> <span class="operator">=</span> getOrder(initializer);</span><br><span class="line">    logger.trace(<span class="string">&quot;Added existing &quot;</span> + type.getSimpleName() + <span class="string">&quot; initializer bean &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;; order=&quot;</span></span><br><span class="line">        + order + <span class="string">&quot;, resource=&quot;</span> + resourceDescription);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以最后在 ServletWebServerApplicationContext 中的 selfInitialize 方法里面通过 getServletContextInitializerBeans 获取到的是 ServletContextInitializerBeans 中保存了我们注册到 Spring 容器的 RegistrationBean 的实例的 sortedList，然后遍历 sortedList 从而调用这些 RegistrationBean 的实例的 onStartup 方法。（如果上面的流程解析看不懂，可以配合源码自己走一遍会更加清晰）</p>
<p>看下 RegistrationBean 的 onStartup 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">onStartup</span><span class="params">(ServletContext servletContext)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">  <span class="type">String</span> <span class="variable">description</span> <span class="operator">=</span> getDescription();</span><br><span class="line">  <span class="keyword">if</span> (!isEnabled()) &#123;</span><br><span class="line">    logger.info(StringUtils.capitalize(description) + <span class="string">&quot; was not registered (disabled)&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//调用子类的register方法</span></span><br><span class="line">  register(description, servletContext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>DynamicRegistrationBean（FilterRegistrationBean 和 ServletRegistrationBean 的父类）实现了 register 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(String description, ServletContext servletContext)</span> &#123;</span><br><span class="line">  <span class="comment">//调用子类的addRegistration方法</span></span><br><span class="line">  <span class="type">D</span> <span class="variable">registration</span> <span class="operator">=</span> addRegistration(description, servletContext);</span><br><span class="line">  <span class="keyword">if</span> (registration == <span class="literal">null</span>) &#123;</span><br><span class="line">    logger.info(StringUtils.capitalize(description) + <span class="string">&quot; was not registered (possibly already registered?)&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  configure(registration);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ServletRegistrationBean 的 addRegistration 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> ServletRegistration.Dynamic <span class="title function_">addRegistration</span><span class="params">(String description, ServletContext servletContext)</span> &#123;</span><br><span class="line">  <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> getServletName();</span><br><span class="line">  <span class="comment">//这里的代码就很熟悉了，这里调用的就是servlet3.0提供的动态注册servlet的方法</span></span><br><span class="line">  <span class="keyword">return</span> servletContext.addServlet(name, <span class="built_in">this</span>.servlet);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看到这就可以大概知道 SpringBoot 是如何加载 servlet 的了，filter 和 listener 也是如此。</p>
<h5 id="注册方式三：继承-ServletContextInitializer-实现-onStartup-方法"><a href="#注册方式三：继承-ServletContextInitializer-实现-onStartup-方法" class="headerlink" title="注册方式三：继承 ServletContextInitializer 实现 onStartup 方法"></a>注册方式三：继承 ServletContextInitializer 实现 onStartup 方法</h5><p>看完上面的分析我们还可以用第三种注册 servlet 的方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomServletContextInitializer</span> <span class="keyword">implements</span> <span class="title class_">ServletContextInitializer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">JAR_HELLO_URL</span> <span class="operator">=</span> <span class="string">&quot;/custom&quot;</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStartup</span><span class="params">(ServletContext servletContext)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;创建 customServlet...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ServletRegistration.<span class="type">Dynamic</span> <span class="variable">servlet</span> <span class="operator">=</span> servletContext.addServlet(</span><br><span class="line">                CustomServlet.class.getSimpleName(),</span><br><span class="line">                CustomServlet.class);</span><br><span class="line">        servlet.addMapping(JAR_HELLO_URL);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;创建 customFilter...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        FilterRegistration.<span class="type">Dynamic</span> <span class="variable">filter</span> <span class="operator">=</span> servletContext.addFilter(</span><br><span class="line">                CustomFilter.class.getSimpleName(), CustomFilter.class);</span><br><span class="line"></span><br><span class="line">        EnumSet&lt;DispatcherType&gt; dispatcherTypes = EnumSet.allOf(DispatcherType.class);</span><br><span class="line">        dispatcherTypes.add(DispatcherType.REQUEST);</span><br><span class="line">        dispatcherTypes.add(DispatcherType.FORWARD);</span><br><span class="line"></span><br><span class="line">        filter.addMappingForUrlPatterns(dispatcherTypes, <span class="literal">true</span>, JAR_HELLO_URL);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后这里提一下上面 ServletWebServerApplicationContext 中 createWebServer 的代码中的 getWebServerFactory()方法，它的作用是从 spring 容器中获取一个类型为 ServletWebServerFactory（TomcatServletWebServerFactory 是其子类）的工厂实例，而这个实例是通过 SpringBoot 的自动装配完成的（SpringBoot 的自动装配可以了解一下）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">protected</span> ServletWebServerFactory <span class="title function_">getWebServerFactory</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// Use bean names so that we don&#x27;t consider the hierarchy</span></span><br><span class="line">  String[] beanNames = getBeanFactory().getBeanNamesForType(ServletWebServerFactory.class);</span><br><span class="line">  <span class="keyword">if</span> (beanNames.length == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ApplicationContextException</span>(<span class="string">&quot;Unable to start ServletWebServerApplicationContext due to missing &quot;</span></span><br><span class="line">        + <span class="string">&quot;ServletWebServerFactory bean.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (beanNames.length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ApplicationContextException</span>(<span class="string">&quot;Unable to start ServletWebServerApplicationContext due to multiple &quot;</span></span><br><span class="line">        + <span class="string">&quot;ServletWebServerFactory beans : &quot;</span> + StringUtils.arrayToCommaDelimitedString(beanNames));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//从spring容器中获取一个类型为ServletWebServerFactory的工厂实例并且返回</span></span><br><span class="line">  <span class="keyword">return</span> getBeanFactory().getBean(beanNames[<span class="number">0</span>], ServletWebServerFactory.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@AutoConfigureOrder(Ordered.HIGHEST_PRECEDENCE)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(ServletRequest.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication(type = Type.SERVLET)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(ServerProperties.class)</span></span><br><span class="line"><span class="meta">@Import(&#123; ServletWebServerFactoryAutoConfiguration.BeanPostProcessorsRegistrar.class,</span></span><br><span class="line"><span class="meta">    //留意这个</span></span><br><span class="line"><span class="meta">    ServletWebServerFactoryConfiguration.EmbeddedTomcat.class,</span></span><br><span class="line"><span class="meta">    ServletWebServerFactoryConfiguration.EmbeddedJetty.class,</span></span><br><span class="line"><span class="meta">    ServletWebServerFactoryConfiguration.EmbeddedUndertow.class &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServletWebServerFactoryAutoConfiguration</span> &#123;</span><br><span class="line">    .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ServletWebServerFactoryConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line">  <span class="meta">@ConditionalOnClass(&#123; Servlet.class, Tomcat.class, UpgradeProtocol.class &#125;)</span></span><br><span class="line">  <span class="meta">@ConditionalOnMissingBean(value = ServletWebServerFactory.class, search = SearchStrategy.CURRENT)</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">EmbeddedTomcat</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    TomcatServletWebServerFactory <span class="title function_">tomcatServletWebServerFactory</span><span class="params">(</span></span><br><span class="line"><span class="params">        ObjectProvider&lt;TomcatConnectorCustomizer&gt; connectorCustomizers,</span></span><br><span class="line"><span class="params">        ObjectProvider&lt;TomcatContextCustomizer&gt; contextCustomizers,</span></span><br><span class="line"><span class="params">        ObjectProvider&lt;TomcatProtocolHandlerCustomizer&lt;?&gt;&gt; protocolHandlerCustomizers)</span> &#123;</span><br><span class="line">      <span class="type">TomcatServletWebServerFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TomcatServletWebServerFactory</span>();</span><br><span class="line">      factory.getTomcatConnectorCustomizers()</span><br><span class="line">          .addAll(connectorCustomizers.orderedStream().collect(Collectors.toList()));</span><br><span class="line">      factory.getTomcatContextCustomizers()</span><br><span class="line">          .addAll(contextCustomizers.orderedStream().collect(Collectors.toList()));</span><br><span class="line">      factory.getTomcatProtocolHandlerCustomizers()</span><br><span class="line">          .addAll(protocolHandlerCustomizers.orderedStream().collect(Collectors.toList()));</span><br><span class="line">      <span class="keyword">return</span> factory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>存在 web.xml 配置的 java web 项目，servlet3.0 的 java web 项目，springboot 内嵌容器的 java web 项目加载 servlet，filter，listener 的流程都是有所差异的，理解清楚这其中的原来，其实并不容易，至少得搞懂 servlet3.0 的规范，springboot 内嵌容器的加载流程等等前置逻辑。</p>
<p>最后还是要感谢<a target="_blank" rel="noopener" href="https://www.cnkirito.moe/servlet-explore/#Initializer-%E8%A2%AB%E6%9B%BF%E6%8D%A2%E4%B8%BA-TomcatStarter">这位大佬的文章</a>，我做的只是在他的基础上针对我自己再补充的笔记，文笔没有大佬的简洁，所以如果觉得说得太啰嗦看不懂建议去看这个大佬的文章，你会发觉你发现了新大陆。</p>

    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/java/" rel="tag"><i class="fa fa-tag"></i> java</a>
              <a href="/tags/Spring/" rel="tag"><i class="fa fa-tag"></i> Spring</a>
              <a href="/tags/SpringBoot/" rel="tag"><i class="fa fa-tag"></i> SpringBoot</a>
              <a href="/tags/Servlet/" rel="tag"><i class="fa fa-tag"></i> Servlet</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/12/16/SPI%E6%9C%BA%E5%88%B6/" rel="prev" title="SPI机制">
      <i class="fa fa-chevron-left"></i> SPI机制
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/01/28/SpringSecurity%20%E6%BA%90%E7%A0%81(%E4%B8%80)%E2%80%94%E2%80%94SpringSecurity%E5%A6%82%E4%BD%95%E8%A2%AB%E5%8A%A0%E8%BD%BD%E8%BF%9B%E6%9D%A5%E7%9A%84%EF%BC%9F/" rel="next" title="SpringSecurity 源码(一)——SpringSecurity如何被加载进来的？">
      SpringSecurity 源码(一)——SpringSecurity如何被加载进来的？ <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Javaweb-%E4%BB%8E-web-xml-%E5%88%B0-springboot"><span class="nav-number">1.</span> <span class="nav-text">Javaweb 从 web.xml 到 springboot</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#servlet3-0-%E4%BB%A5%E5%89%8D%E7%9A%84%E6%97%B6%E4%BB%A3%EF%BC%88%E4%BD%BF%E7%94%A8-web-xml-%E9%85%8D%E7%BD%AE%EF%BC%89"><span class="nav-number">1.2.</span> <span class="nav-text">servlet3.0 以前的时代（使用 web.xml 配置）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#servlet3-0-%E6%96%B0%E7%89%B9%E6%80%A7"><span class="nav-number">1.3.</span> <span class="nav-text">servlet3.0 新特性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Spring-%E6%98%AF%E5%A6%82%E4%BD%95%E6%94%AF%E6%8C%81-servlet3-0-%E7%9A%84%EF%BC%9F"><span class="nav-number">1.4.</span> <span class="nav-text">Spring 是如何支持 servlet3.0 的？</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-xml-%E9%85%8D%E7%BD%AE%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="nav-number">1.4.1.</span> <span class="nav-text">使用 xml 配置的方式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%8C%E5%85%A8%E6%97%A0-xml-%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F"><span class="nav-number">1.4.2.</span> <span class="nav-text">完全无 xml 的配置方式</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SpringBoot-%E6%98%AF%E5%A6%82%E4%BD%95%E5%8A%A0%E8%BD%BD-Servlet-%E7%9A%84"><span class="nav-number">1.5.</span> <span class="nav-text">SpringBoot 是如何加载 Servlet 的</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C%E6%96%B9%E5%BC%8F%E4%B8%80%EF%BC%9Aservlet3-0-%E6%B3%A8%E8%A7%A3-ServletComponentScan"><span class="nav-number">1.5.1.</span> <span class="nav-text">注册方式一：servlet3.0 注解 +@ServletComponentScan</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C%E6%96%B9%E5%BC%8F%E4%BA%8C%EF%BC%9ARegistrationBean"><span class="nav-number">1.5.2.</span> <span class="nav-text">注册方式二：RegistrationBean</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SpringBoot-%E5%86%85%E7%BD%AE-tomcat-%E5%AE%B9%E5%99%A8%E5%8A%A0%E8%BD%BD-servlet-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">1.5.3.</span> <span class="nav-text">SpringBoot 内置 tomcat 容器加载 servlet 源码分析</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C%E6%96%B9%E5%BC%8F%E4%B8%89%EF%BC%9A%E7%BB%A7%E6%89%BF-ServletContextInitializer-%E5%AE%9E%E7%8E%B0-onStartup-%E6%96%B9%E6%B3%95"><span class="nav-number">1.5.4.</span> <span class="nav-text">注册方式三：继承 ServletContextInitializer 实现 onStartup 方法</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">1.6.</span> <span class="nav-text">总结</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="ouzhanbo"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">ouzhanbo</p>
  <div class="site-description" itemprop="description">好烦想辞职</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">11</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/OUZHANBO" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;OUZHANBO" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:yuzai1435701781@gmail.com" title="E-Mail → mailto:yuzai1435701781@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">粤ICP备20010439号-1 </a>
  </div>

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ouzhanbo</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">150k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">2:16</span>
</div>

        
<div class="busuanzi-count">
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-pjax@0/pjax.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/medium-zoom@1/dist/medium-zoom.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  




  
<script src="/js/local-search.js"></script>













    <div id="pjax">
  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
          load: ['[tex]/mhchem'],
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
          packages: {'[+]': ['mhchem']},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  
  <script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 3000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'https://ouzhanbo.top/2022/01/21/Javaweb%E4%BB%8Eweb.xml%20%E5%88%B0%20springboot/',]
      });
      });
  </script>

    </div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":true}});</script></body>
</html>
